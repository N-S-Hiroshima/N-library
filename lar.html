<!DOCTYPE html>
<html lang="ja">

<head>
    <title>lending and returning</title>

    <!--CSS-->
    <link rel="stylesheet" href="./css/lar.css">
    <!--外部JS-->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <!--自作JS-->
    <script src="./js/google-login.js"></script>
    <script src="./js/api.js"></script>
    <script src="./js/jquery-barcode.js"></script>


</head>

<body>
    <header>
        <script src="./js/header.js"></script>
        <script>header();</script>
    </header>
    <textarea id="keyview"></textarea>
    <script>
        let texts, system_mode, bookdata, reservationdata, userdata, userid
        document.addEventListener('keypress', keypress_ivent);
        document.addEventListener('keyup', keyup_ivent);
        function keyup_ivent(e) {
            if (e.key == "Backspace") {
                texts = ""
                document.getElementById("keyview").innerHTML = texts
            }
            return;
        }

        function keypress_ivent(e) {
            //いずれかのキーが押された時の処理
            if (e.key != 'Enter') {
                if (texts) {
                    texts = texts + e.key
                } else {
                    texts = e.key
                }
            } else if (e.key == "Enter") {
                scan(texts)
                texts = ""
            }
            document.getElementById("keyview").innerHTML = texts
            return false;
        }

        function scan(texts) {
            switch (texts) {
                case "LENDING":
                    system_mode = "lending"
                    userdata = undefined
                    send("book_num")
                    break;
                case "RETRUN0":
                    system_mode = "retrun"
                    userdata = undefined
                    send("book_num")
                    break;

                default:
                    if (!system_mode == "") {
                        if (system_mode == "retrun") {
                                console.log(" hennkyakusyori")
                                send("retrun", userid, texts, new Date().toLocaleString())
                          

                            return
                        } else if (system_mode == "lending") {
                            if (userdata < 3 && texts.length != 21) {
                                //貸出処理
                                for (let i = 1; i < bookdata.length; i++) {
                                    if (bookdata[i][0] == texts) {
                                        if (bookdata[i][22] == "許可") {
                                            if (bookdata[i][21] != 0) {
                                                //貸出許可
                                                console.log("許可確認")
                                                //userid,isbn,yoyaku,kasidasi,hennkyaku,status,bagou,taitoru,gazou,namae
                                                send("lending", userid, texts, new Date().toLocaleString())
                                                bookdata[i][21]--
                                                userdata++

                                            } else {
                                                console.log(bookdata[i][19])
                                                if (bookdata[i][19] > 0) {
                                                    for (let q = 0; q < reservationdata.length; q++) {
                                                        console.log(reservationdata[q][5], reservationdata[q][0], userid)
                                                        if (reservationdata[q][5] == "予約中" && reservationdata[q][0] == userid) {
                                                            send("lending2", userid, texts, new Date().toLocaleString())
                                                            bookdata[i][21]--
                                                            userdata++
                                                            return
                                                        }
                                                    }
                                                }
                                                //在庫なし
                                                console.log("在庫なし")
                                            }

                                        } else {
                                            //貸出禁止
                                            console.log("禁止")
                                        }
                                        return
                                    }
                                }
                                //bookdataなし
                                console.log("なかった")

                            } else if (userdata > 2 && texts.length != 21) {
                                //上限に達した
                                alert("上限に達しました")

                            } else if (texts.length == 21) {
                                //会員IDを読み取った時
                                userdata = ""
                                userid = texts
                                send("user_cheak", texts)

                            } else {
                                //IDをスキャン
                                console.log("ユーザーID SCANして")
                            }
                        }
                        break;
                    } else {
                        console.log("モード選択")
                    }
            }
        }


        send("book_num")

    </script>
</body>

</html>